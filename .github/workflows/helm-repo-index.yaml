name: Helm repo index
on: [push]
#on: release
jobs:
  publish:
    name: Publish helm repo index to gh-pages
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install chart-releaser
        uses: giantswarm/install-binary-action@v1.0.0
        with:
          binary: "cr"
          version: "1.4.0"
          download_url: https://github.com/helm/chart-releaser/releases/download/v${version}/chart-releaser_${version}_linux_amd64.tar.gz
          tarball_binary_path: ${binary}
          smoke_test: ${binary} version

      - name: Generate index.yaml
        run: |
          mkdir .helm-index
          cr index \
            --package-path charts \
            --owner ${GITHUB_REPOSITORY_OWNER} \
            --git-repo ${GITHUB_REPOSITORY} \
            --index-path .helm-index/index.yaml \
            --push

      - name: Publish to gh-pages
        uses: JamesIves/github-pages-deploy-action@releases/v3
        with:
          ACCESS_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: gh-pages # The branch the action should deploy to.
          FOLDER: .helm-index # The folder the action should deploy.
